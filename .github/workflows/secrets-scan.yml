name: Secrets Scan

# This workflow runs on ALL pushes to detect secrets BEFORE they get merged
# It's designed to catch secrets early and block the PR/push

on:
  push:
    branches: ['**']  # All branches
  pull_request:
    branches: ['**']  # All PRs

jobs:
  gitleaks:
    name: Gitleaks Secret Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_ENABLE_COMMENTS: true  # Comment on PR if secrets found

  trufflehog:
    name: TruffleHog Deep Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  custom-patterns:
    name: Custom Pattern Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for trading-specific secrets
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Scanning for trading platform secrets..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          ERRORS=0

          # Check for .env files that shouldn't be committed
          if git ls-files | grep -E "^(\.env|tradegent/\.env)$" | grep -v ".template" | grep -v ".example"; then
            echo "âŒ ERROR: .env file is tracked in git!"
            echo "   Run: git rm --cached .env && echo '.env' >> .gitignore"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for OpenAI keys
          if grep -rn "sk-proj-[a-zA-Z0-9_-]\{20,\}" --include="*.py" --include="*.json" --include="*.yaml" --include="*.yml" --include="*.md" . 2>/dev/null | grep -v ".template" | grep -v "gitleaks" | grep -v ".example"; then
            echo "âŒ ERROR: OpenAI API key found in code!"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for Anthropic keys
          if grep -rn "sk-ant-[a-zA-Z0-9_-]\{20,\}" --include="*.py" --include="*.json" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v ".template"; then
            echo "âŒ ERROR: Anthropic API key found in code!"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for PostgreSQL connection strings with passwords
          if grep -rn "postgresql://[^:]*:[^@]*@" --include="*.py" --include="*.json" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v ".template" | grep -v "test_" | grep -v "conftest"; then
            echo "âŒ ERROR: PostgreSQL connection string with embedded password!"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for IB credentials
          if grep -rn "IB_PASS.*=.*['\"][^<>\$][^'\"]\{4,\}['\"]" --include="*.env" --include="*.py" --include="*.json" . 2>/dev/null | grep -v ".template" | grep -v ".example"; then
            echo "âŒ ERROR: Interactive Brokers password found!"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for VNC passwords (not placeholders)
          if grep -rn "VNC_PASS.*=.*['\"][^<>\$][^'\"]\{4,\}['\"]" --include="*.env" --include="*.yml" . 2>/dev/null | grep -v ".template" | grep -v ".example" | grep -v "nexus123"; then
            echo "âš ï¸  WARNING: VNC password found (verify it's not production)"
          fi

          # Summary
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ $ERRORS -gt 0 ]; then
            echo "ğŸš¨ SCAN FAILED: $ERRORS secret(s) detected"
            echo ""
            echo "To fix:"
            echo "1. Remove the secrets from the files"
            echo "2. Use environment variables instead"
            echo "3. See .env.template for correct format"
            echo "4. If already committed, rotate the credentials immediately"
            exit 1
          else
            echo "âœ… SCAN PASSED: No secrets detected"
          fi

  notify-on-failure:
    name: Notify on Secret Detection
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, custom-patterns]
    if: failure()
    steps:
      - name: Create issue for secret exposure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ SECURITY: Potential secret detected in commit',
              body: `## Secret Detection Alert

            A potential secret was detected in commit ${context.sha}.

            **Action Required:**
            1. Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details
            2. If a real secret was exposed:
               - **Rotate the credential immediately**
               - Remove from git history using \`git filter-branch\` or BFG
               - Update .gitignore to prevent future exposure
            3. If false positive, update \`.gitleaks.toml\` allowlist

            **Commit:** ${context.sha}
            **Branch:** ${context.ref}
            **Author:** ${context.actor}
            `,
              labels: ['security', 'urgent']
            });
            console.log(`Created issue #${issue.data.number}`);
        continue-on-error: true
