name: Validate & Sync Documents

on:
  push:
    branches: [main]
    paths:
      - 'trading/knowledge/**/*.yaml'
      - 'trading/knowledge/**/*.yml'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Force full re-sync of all documents'
        required: false
        default: 'false'
        type: boolean
      sync_mode:
        description: 'Sync mode (auto, local, http, dry-run)'
        required: false
        default: 'dry-run'
        type: choice
        options:
          - auto
          - local
          - http
          - dry-run

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema

      - name: Detect changed files
        id: changes
        run: |
          if [ "${{ github.event.inputs.full_sync }}" == "true" ]; then
            FILES=$(find trading/knowledge -name '*.yaml' -o -name '*.yml' | tr '\n' ' ')
          else
            FILES=$(git diff --name-only HEAD~1 HEAD -- 'trading/knowledge/**/*.yaml' 'trading/knowledge/**/*.yml' | tr '\n' ' ')
          fi
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"

      - name: Validate documents
        if: steps.changes.outputs.files != ''
        run: |
          python trading/workflows/.github/scripts/validate.py ${{ steps.changes.outputs.files }}

  sync:
    needs: validate
    runs-on: ubuntu-latest
    # For actual sync, use a self-hosted runner with database access:
    # runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pyyaml httpx psycopg[binary] neo4j tiktoken

      - name: Detect changed files
        id: changes
        run: |
          if [ "${{ github.event.inputs.full_sync }}" == "true" ]; then
            FILES=$(find trading/knowledge -name '*.yaml' -o -name '*.yml' | tr '\n' ' ')
          else
            FILES=$(git diff --name-only HEAD~1 HEAD -- 'trading/knowledge/**/*.yaml' 'trading/knowledge/**/*.yml' | tr '\n' ' ')
          fi
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Sync to RAG+Graph
        if: steps.changes.outputs.files != ''
        env:
          SYNC_MODE: ${{ github.event.inputs.sync_mode || 'dry-run' }}
          # For self-hosted runner with database access:
          # PG_HOST: ${{ secrets.PG_HOST }}
          # PG_PORT: ${{ secrets.PG_PORT }}
          # PG_USER: ${{ secrets.PG_USER }}
          # PG_PASS: ${{ secrets.PG_PASS }}
          # PG_DB: ${{ secrets.PG_DB }}
          # NEO4J_URI: ${{ secrets.NEO4J_URI }}
          # NEO4J_USER: ${{ secrets.NEO4J_USER }}
          # NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        run: |
          python trading/workflows/.github/scripts/sync.py ${{ steps.changes.outputs.files }}

      - name: Update sync status
        if: always()
        run: |
          mkdir -p trading/workflows/.lightrag
          cat > trading/workflows/.lightrag/sync-status.yaml << EOF
          last_sync: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          commit: ${{ github.sha }}
          status: ${{ job.status }}
          sync_mode: ${{ github.event.inputs.sync_mode || 'dry-run' }}
          EOF
